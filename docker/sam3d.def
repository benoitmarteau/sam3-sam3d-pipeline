# =============================================================================
# Apptainer/Singularity Definition File for SAM3 + SAM3D Pipeline
# =============================================================================
# This builds an Apptainer image from the NVIDIA PyTorch 24.10 base.
#
# Build (on a node with internet access):
#   apptainer build sam3d.sif sam3d.def
#
# Run:
#   apptainer run --nv sam3d.sif python /app/webapp/app.py
#
# BASE IMAGE: nvcr.io/nvidia/pytorch:24.10-py3
#   - Python 3.10
#   - PyTorch 2.9.1 with CUDA 12.8 (supports torch.nn.attention APIs)
#   - torchvision, torchaudio
#   - NumPy, SciPy, and many ML libraries
#
# WHY PyTorch 2.5+:
#   SAM3 requires torch.nn.attention.sdpa_kernel (introduced in PyTorch 2.5).
#   24.10 has PyTorch 2.9.1 which fully supports these APIs.
#
# NOTE: Pre-built kaolin and flash_attn have ABI issues with 2.9.1.
#       Set SPARSE_ATTN_BACKEND=sdpa to use PyTorch native attention instead.
#
# =============================================================================

Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.10-py3

%labels
    Author Benoit Marteau
    Version 3.0
    Description SAM3 + SAM3D 3D Object Extraction Pipeline (PyTorch 2.5)

%environment
    # CUDA Configuration
    export CUDA_HOME=/usr/local/cuda
    export PATH="${CUDA_HOME}/bin:${PATH}"
    export LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}"

    # PyTorch CUDA Architecture (H200 = 9.0, A100 = 8.0)
    # Note: Volta (7.0) support dropped in 24.10
    export TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9;9.0"
    export FORCE_CUDA=1

    # Application settings
    export GRADIO_ANALYTICS_ENABLED=false
    export PYTHONUNBUFFERED=1
    export PYTHONDONTWRITEBYTECODE=1

    # Skip SAM3D init module (not present in repo)
    export LIDRA_SKIP_INIT=1

    # nvdiffrast JIT compilation directory
    export NVDIFFRAST_CACHE_DIR=/tmp/nvdiffrast_cache

    # Suppress warnings
    export HYDRA_FULL_ERROR=1

    # Fix SSL certificate issues (NVIDIA container may set invalid paths)
    unset SSL_CERT_FILE
    unset REQUESTS_CA_BUNDLE

    # Required by Meta's inference.py (expects conda environment)
    export CONDA_PREFIX=/usr/local/cuda

%post
    # =========================================================================
    # Initial Setup
    # =========================================================================
    export DEBIAN_FRONTEND=noninteractive
    export TZ=UTC

    # Set CUDA environment for compilation during build
    export CUDA_HOME=/usr/local/cuda
    export PATH="${CUDA_HOME}/bin:${PATH}"
    export LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}"
    export TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9;9.0"
    export FORCE_CUDA=1

    # =========================================================================
    # Record PyTorch version from base container
    # =========================================================================
    echo ">>> Recording base PyTorch version..."
    TORCH_VERSION=$(python -c "import torch; print(torch.__version__)")
    CUDA_VERSION=$(python -c "import torch; print(torch.version.cuda)")
    echo "Base PyTorch: ${TORCH_VERSION}, CUDA: ${CUDA_VERSION}"

    # Verify torch.nn.attention is available (PyTorch 2.5+ feature)
    python -c "from torch.nn.attention import sdpa_kernel, SDPBackend; print('torch.nn.attention: OK')" \
        || { echo "ERROR: torch.nn.attention not available - need PyTorch 2.5+"; exit 1; }

    # =========================================================================
    # System Dependencies
    # =========================================================================
    echo ">>> Installing system dependencies..."
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        unzip \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgomp1 \
        libglu1-mesa \
        libxi6 \
        libxmu6 \
        xvfb \
        ffmpeg \
        libavcodec-dev \
        libavformat-dev \
        libswscale-dev \
        ninja-build \
        && rm -rf /var/lib/apt/lists/*

    # =========================================================================
    # Upgrade pip and essential build tools
    # =========================================================================
    echo ">>> Upgrading pip and build tools..."
    pip install --no-cache-dir --upgrade pip setuptools wheel

    # =========================================================================
    # Pin NumPy to 1.x (NumPy 2.0 breaks binary compatibility with many packages)
    # =========================================================================
    echo ">>> Pinning NumPy to 1.x for binary compatibility..."
    pip install --no-cache-dir "numpy>=1.24,<2.0"

    # =========================================================================
    # Core Python Dependencies
    # =========================================================================
    echo ">>> Installing core Python dependencies..."
    pip install --no-cache-dir \
        pillow>=10.0.0 \
        scipy \
        scikit-image \
        matplotlib \
        tqdm \
        einops \
        omegaconf \
        hydra-core==1.3.2 \
        loguru==0.7.2 \
        trimesh \
        imageio \
        imageio-ffmpeg \
        astor

    # =========================================================================
    # PyTorch3D Installation
    # =========================================================================
    echo ">>> Installing PyTorch3D..."
    pip install --no-cache-dir fvcore iopath

    # Build from source with --no-build-isolation (needs torch during setup)
    echo ">>> Building PyTorch3D from source (this takes ~10-15 minutes)..."
    pip install --no-cache-dir --no-build-isolation \
        "git+https://github.com/facebookresearch/pytorch3d.git@stable" \
        || echo ">>> WARNING: PyTorch3D installation failed"

    # =========================================================================
    # nvdiffrast Installation (for texture baking)
    # =========================================================================
    echo ">>> Installing nvdiffrast..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/NVlabs/nvdiffrast.git \
        || echo ">>> WARNING: nvdiffrast installation failed"

    # =========================================================================
    # SAM3D Core Dependencies (Phase 1 - pip packages that may change PyTorch)
    # =========================================================================
    echo ">>> Installing SAM3D dependencies (Phase 1)..."

    # ML/Transformer dependencies
    pip install --no-cache-dir \
        "timm>=1.0.17" \
        "transformers>=4.36.0,<4.50" \
        "accelerate>=0.25.0,<1.0" \
        safetensors \
        "lightning==2.3.3"

    # Sparse convolution for 3D processing
    echo ">>> Installing spconv..."
    pip install --no-cache-dir spconv-cu120==2.3.8 \
        || pip install --no-cache-dir spconv-cu121==2.3.8 \
        || echo ">>> WARNING: spconv installation failed"

    # MoGe for monocular geometry estimation (Microsoft)
    echo ">>> Installing MoGe..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/microsoft/MoGe.git \
        || echo ">>> WARNING: MoGe installation failed"

    # Additional 3D dependencies (from SAM3D requirements.txt)
    echo ">>> Installing additional 3D dependencies..."
    pip install --no-cache-dir \
        roma \
        point-cloud-utils \
        open3d==0.18.0 \
        seaborn \
        xatlas==0.0.9 \
        pyvista \
        pymeshfix \
        python-igraph \
        easydict \
        plyfile

    # utils3d for 3D utilities (used by SAM3D for texture baking)
    echo ">>> Installing utils3d..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/EasternJournalist/utils3d.git \
        || echo ">>> WARNING: utils3d installation failed"

    # =========================================================================
    # SAM3 Dependencies (from pyproject.toml)
    # =========================================================================
    echo ">>> Installing SAM3 dependencies..."
    pip install --no-cache-dir \
        "timm>=1.0.17" \
        "numpy>=1.24,<2.0" \
        ftfy==6.1.1 \
        regex \
        "iopath>=0.1.10" \
        typing_extensions \
        huggingface_hub \
        decord

    # =========================================================================
    # Web Application Dependencies (INSTALL BEFORE building CUDA extensions!)
    # NOTE: Gradio and its dependencies can pull in newer PyTorch versions.
    #       We install it here so that flash_attn/kaolin are built against
    #       the final PyTorch version that ends up installed.
    # =========================================================================
    echo ">>> Installing web application dependencies..."
    pip install --no-cache-dir \
        fastapi \
        "uvicorn[standard]" \
        python-multipart \
        aiofiles

    # Gradio for alternative UI (optional)
    # This may pull in a newer PyTorch version - that's OK, we build CUDA exts after
    echo ">>> Installing Gradio (may update PyTorch version)..."
    pip install --no-cache-dir gradio>=4.0.0 || echo ">>> gradio install failed"

    # =========================================================================
    # Re-pin NumPy (Gradio may have upgraded it to 2.x)
    # =========================================================================
    echo ">>> Re-enforcing NumPy 1.x..."
    pip install --no-cache-dir "numpy>=1.24,<2.0" --force-reinstall

    # =========================================================================
    # Fix OpenCV installation conflicts
    # =========================================================================
    echo ">>> Fixing OpenCV installation..."
    pip uninstall -y opencv-python opencv-python-headless opencv-contrib-python 2>/dev/null || true
    rm -rf /usr/local/lib/python3.10/dist-packages/cv2/ 2>/dev/null || true
    pip install --no-cache-dir "opencv-python-headless>=4.8.0"

    # =========================================================================
    # Record FINAL PyTorch version after all pip installs
    # All CUDA extensions below will be built against this version
    # =========================================================================
    echo ">>> Recording final PyTorch version for CUDA extension builds..."
    FINAL_TORCH_VERSION=$(python -c "import torch; print(torch.__version__)")
    FINAL_CUDA_VERSION=$(python -c "import torch; print(torch.version.cuda)")
    echo "Final PyTorch: ${FINAL_TORCH_VERSION}, CUDA: ${FINAL_CUDA_VERSION}"

    # Verify torch.nn.attention is still available
    python -c "from torch.nn.attention import sdpa_kernel, SDPBackend; print('torch.nn.attention: OK')" \
        || { echo "ERROR: torch.nn.attention not available after pip installs!"; exit 1; }

    # =========================================================================
    # CUDA Extension Builds (Phase 2 - must be LAST!)
    # These packages compile C++/CUDA code against the current PyTorch version.
    # Any pip install after this point that changes PyTorch will break them!
    # =========================================================================
    echo ">>> Building CUDA extensions against PyTorch ${FINAL_TORCH_VERSION}..."

    # xformers - try pre-built first, fall back to no-deps
    echo ">>> Installing xformers..."
    pip install --no-cache-dir xformers --no-deps \
        || echo ">>> WARNING: xformers install failed"

    # gsplat for Gaussian Splatting rendering
    echo ">>> Installing gsplat from source..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/nerfstudio-project/gsplat.git@v1.0.0 \
        || pip install --no-cache-dir gsplat==1.0.0 \
        || echo ">>> WARNING: gsplat installation failed"

    # Flash attention for efficient transformer inference
    # CRITICAL: Must build from source for ABI compatibility
    echo ">>> Installing flash-attn from source (this takes ~20-30 minutes)..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/Dao-AILab/flash-attention.git@v2.7.2 \
        || echo ">>> WARNING: flash-attn installation failed - will use SDPA fallback"

    # Kaolin for 3D deep learning (NVIDIA library)
    # CRITICAL: Must build from source for ABI compatibility
    echo ">>> Installing Kaolin from source (this takes ~15-20 minutes)..."
    pip install --no-cache-dir --no-build-isolation \
        git+https://github.com/NVIDIAGameWorks/kaolin.git@v0.17.0 \
        || echo ">>> WARNING: Kaolin installation failed"

    # =========================================================================
    # IMPORTANT: No more pip installs after this point!
    # Any package that pulls in a different PyTorch version will break
    # kaolin, flash_attn, and other CUDA extensions built above.
    # =========================================================================

    # =========================================================================
    # Create app directory structure
    # =========================================================================
    echo ">>> Creating app directory..."
    mkdir -p /app/webapp_outputs /app/logs

    # =========================================================================
    # Verify installations
    # =========================================================================
    echo ">>> Verifying key installations..."
    python -c "import numpy; print(f'NumPy: {numpy.__version__}')" || echo ">>> NumPy: FAILED"
    python -c "import torch; print(f'PyTorch: {torch.__version__}')" || echo ">>> PyTorch: FAILED"
    python -c "from torch.nn.attention import sdpa_kernel; print('torch.nn.attention: OK')" || echo ">>> torch.nn.attention: FAILED"
    python -c "import pytorch3d; print(f'PyTorch3D: OK')" || echo ">>> PyTorch3D: not installed"
    python -c "import spconv; print('spconv: OK')" || echo ">>> spconv: not installed"
    python -c "import kaolin; print('kaolin: OK')" || echo ">>> kaolin: not installed"
    python -c "import flash_attn; print('flash_attn: OK')" || echo ">>> flash_attn: not installed"
    python -c "import xformers; print('xformers: OK')" || echo ">>> xformers: not installed"
    python -c "import transformers; print(f'transformers: {transformers.__version__}')" || echo ">>> transformers: FAILED"
    python -c "import fastapi; print(f'FastAPI: {fastapi.__version__}')" || echo ">>> FastAPI: FAILED"
    python -c "import cv2; print(f'OpenCV: {cv2.__version__}')" || echo ">>> OpenCV: FAILED"
    python -c "import xatlas; print('xatlas: OK')" || echo ">>> xatlas: not installed"
    python -c "import pyvista; print('pyvista: OK')" || echo ">>> pyvista: not installed"
    python -c "import pymeshfix; print('pymeshfix: OK')" || echo ">>> pymeshfix: not installed"
    python -c "import igraph; print('igraph: OK')" || echo ">>> igraph: not installed"
    python -c "import easydict; print('easydict: OK')" || echo ">>> easydict: not installed"

    echo ">>> Build complete!"

%runscript
    exec python -u "$@"

%startscript
    cd /app && python -u /app/webapp/app.py

%help
    SAM3 + SAM3D 3D Object Extraction Pipeline

    This container provides:
    - SAM3 (Segment Anything Model 3) for text-based segmentation
    - SAM3D for 3D object reconstruction from 2D images
    - nvdiffrast for texture baking and mesh generation
    - FastAPI web application for easy interaction

    Base Image: nvcr.io/nvidia/pytorch:24.10-py3
    - PyTorch 2.5.0 (native torch.nn.attention support)
    - CUDA 12.6
    - Python 3.10

    Requirements:
    - NVIDIA GPU with CUDA support (32GB+ VRAM recommended)
    - Ampere or newer GPU architecture (A100, H100, H200)
    - NVIDIA Driver 560+

    Usage:
      # Run the webapp (bind mount the project directory)
      apptainer exec --nv \
        --bind /path/to/project/sam3:/app/sam3:ro \
        --bind /path/to/project/sam-3d-objects:/app/sam-3d-objects:ro \
        --bind /path/to/project/pipeline.py:/app/pipeline.py:ro \
        --bind /path/to/project/webapp:/app/webapp:ro \
        --bind /path/to/project/webapp_outputs:/app/webapp_outputs \
        sam3d.sif python -u /app/webapp/app.py

      # Interactive shell
      apptainer shell --nv sam3d.sif

      # Run a custom script
      apptainer exec --nv sam3d.sif python your_script.py

    Environment variables:
      PORT          - Web server port (default: 8000)
      CUDA_VISIBLE_DEVICES - GPU selection

%test
    # Quick sanity check
    python -c "import torch; print(f'PyTorch: {torch.__version__}')"
    python -c "from torch.nn.attention import sdpa_kernel, SDPBackend; print('torch.nn.attention: OK')"
    python -c "import fastapi; print('FastAPI: OK')"
    echo "Container tests passed!"
